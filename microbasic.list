# file opened: microbasic.asm
  1   0000              ; From the book "Interface 1 and Microdrive Programmin (Spanish)"
  2   0000              ; Written August 1983. Book Published 1984 under (c) Anaya Multimedia SA. ISBN 84-7614-038-X
  3   0000              ; Author: Agustin Nunez @agnuca https://github.com/agnunez/MicroBasic
  4   0000              ; Code: NonoComercial Creative Commons Internationa (CC BY-NC 4.0)
  5   0000
  6   0000                  DEVICE ZXSPECTRUM48
  7   0000              ; ROM1  rountines entry points
  8   0000
  9   0000              GETCHA EQU 0x0018
 10   0000              NEXCHA EQU 0x0020  ;
 11   0000
 12   0000              ; ROM2 (Interface 1) rountines entry points
 13   0000              CALROM1  EQU 0x10    ; Call a ROM1 routine from ROM2
 14   0000
 15   0000              ; System Variables
 16   0000              var01 EQU 0x5C81
 17   0000              var02 EQU 0x5CB0
 18   0000              inichad EQU 0x5C5D
 19   0000              RAMTOP EQU 0x5CB2
 20   0000              VECTOR  EQU 0x5CB7  ; Hook address for command extension while syntax error found
 21   0000              grchbuf EQU 0xFF58
 22   0000
 23   0000                 ORG 0xF733  ; Load binary in 63283
 24   F733              rtop EQU $-1
 25   F733 21 32 F7         LD HL,rtop      ; Load RAMTOP  with our firmware start address
 26   F736 22 B2 5C         LD (RAMTOP),HL  ; RAMTOP System Variable address
 27   F739 C3 7B FA         JP rtv          ; jump to initialization routine
 28   F73C              ;ROM1 routines entry points
 29   F73C
 30   F73C              main:
 31   F73C              exten:              ; Entry point with ROM2 active
 32   F73C D7               RST CALROM1      ; ROM2 call ROM1 at def word below
 33   F73D 18 00            DEFW GETCHA     ; GET-CHAR from ROM1 into A
 34   F73F 22 81 5C         LD (var01),HL
 35   F742 0E 00            LD C,0
 36   F744 21 4D F7         LD HL, stab
 37   F747 C3 E6 F7         JP othcm
 38   F74A              vecin:
 39   F74A C3 D8 FD         JP inter
 40   F74D              stab:
 41   F74D E3 A0            DEFB 0xE3,0xA0		; CODE "READ"
 42   F74F E5 A0            DEFB 0xE5,0xA0		; CODE "RESTORE"
 43   F751 BF A0            DEFB 0xBF,0xA0		; CODE "IN"
 44   F753 F3 A0            DEFB 0xF3,0xA0		; CODE "NEXT"
 45   F755 2E 4F 4E 45      DEFB ".ONERROR:",0xEC,0xA0	; + CODE 'GOTO'"
 45   F759 52 52 4F 52
 45   F75D 3A EC A0
 46   F760 2E 4F 46 46      DEFB ".OFFERROR",0xA0
 46   F764 45 52 52 4F
 46   F768 52 A0
 47   F76A 2E 52 45 4E      DEFB ".REN",0xA0
 47   F76E A0
 48   F76F 2E 4E 45 57      DEFB ".NEW",0xA0
 48   F773 A0
 49   F774 2E 54 52 46      DEFB ".TRF",0xA0
 49   F778 A0
 50   F779 2E 44 45 4C      DEFB ".DEL",0xA0
 50   F77D A0
 51   F77E 2E 46 4E 44      DEFB ".FND",0xA0
 51   F782 A0
 52   F783 2E 43 48 41      DEFB ".CHA",0xA0
 52   F787 A0
 53   F788 2E 41 4F 46      DEFB ".AOF",0xA0
 53   F78C A0
 54   F78D 2E 41 4F 4E      DEFB ".AON",0xA0
 54   F791 A0
 55   F792 AA A0            DEFB 0xAA,0xA0 ; CODE "SCREEN$"
 56   F794 C3 A0            DEFB 0xC3,0xA0 ; CODE "NOT"  (SAVE)
 57   F796 2D A0            DEFB 0x2D,0xA0 ; CODE "-"	 (LOAD)
 58   F798 3C A0            DEFB 0x3C,0xA0 ; CODE "<"	 (VERIFY)
 59   F79A 3E A0            DEFB 0x3E,0xA0 ; CODE ">"	 (MERGE)
 60   F79C 26 A0            DEFB 0x26,0xA0 ; CODE "&"	 (MOVE)
 61   F79E 27 A0            DEFB 0x27,0xA0 ; CODE "'"	 (ERASE)
 62   F7A0 5F A0            DEFB 0x5F,0xA0 ; CODE "_"	 (FORMAT)
 63   F7A2 24 A0            DEFB 0x24,0xA0 ; CODE "$"	 (OPEN#)
 64   F7A4              finstab:
 65   F7A4 FF               DEFB 0xFF	   ; End of command table
 66   F7A5 00 00 00 00      DEFB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 ; Filler
 66   F7A9 00 00 00 00
 67   F7AD              rtab:		  ; command code start address table
 68   F7AD 23 F8            DEFW comm
 69   F7AF 23 F8            DEFW comm
 70   F7B1 23 F8            DEFW comm
 71   F7B3 23 F8            DEFW nexts
 72   F7B5 23 F8            DEFW roner
 73   F7B7 23 F8            DEFW offer
 74   F7B9 DA FA            DEFW rren
 75   F7BB 32 FA            DEFW rnew
 76   F7BD 9F FA            DEFW rtr
 77   F7BF DA FA            DEFW rren
 78   F7C1 A9 FC            DEFW rfnd
 79   F7C3 B8 FC            DEFW rcha
 80   F7C5 AA FD            DEFW raof
 81   F7C7 BB FD            DEFW raon
 82   F7C9 23 F8            DEFW rcopy
 83   F7CB F0 FE            DEFW rsave
 84   F7CD F4 FE            DEFW rload
 85   F7CF F8 FE            DEFW rvery
 86   F7D1 FC FE            DEFW rmerg
 87   F7D3 06 FF            DEFW rmove
 88   F7D5 0A FF            DEFW reras
 89   F7D7 0E FF            DEFW rform
 90   F7D9              finrtab
 91   F7D9 18 FF            DEFW ropen
 92   F7DB              rlibre:
 93   F7DB 00 00 00 00      DEFB 0x0,0x0,0x0,0x0
 94   F7DF              other:
 95   F7DF C5               PUSH BC
 96   F7E0 E5               PUSH HL
 97   F7E1 D7               RST CALROM1 // Call NEXCHA of ROM1 from ROM2
 98   F7E2 20 00            DEFW NEXCHA  // NEXT-CHAR from ROM1 incrementing CH-ADD
 99   F7E4 E1               POP HL
100   F7E5 C1               POP BC
101   F7E6              othcm:
102   F7E6 46               LD B,(HL)
103   F7E7 B8               CP B
104   F7E8 28 1E            JR Z, mat1
105   F7EA 47               LD B,A
106   F7EB              nmat1:
107   F7EB 23               INC HL
108   F7EC 7E               LD A,(HL)
109   F7ED FE FF            CP 0xFF
110   F7EF 28 14            JR Z, taber
111   F7F1 FE A0            CP 0xA0
112   F7F3 20 F6            JR NZ, nmat1
113   F7F5 23               INC HL
114   F7F6 78               LD A,B
115   F7F7 E5               PUSH HL
116   F7F8 2A 81 5C         LD HL,(var01)
117   F7FB 22 5D 5C         LD (inichad),HL
118   F7FE D7               RST CALROM1
119   F7FF 18 00            DEFW GETCHA         ; GET-CHAR at ROM1
120   F801 E1               POP HL
121   F802 0C               INC C
122   F803 18 E1            JR othcm
123   F805              taber:
124   F805 C3 F0 01         JP 0x01F0
125   F808              mat1:
126   F808 47               LD B,A
127   F809 23               INC HL
128   F80A 7E               LD A, (HL)
129   F80B FE A0            CP 0xA0
130   F80D 28 02            JR Z, found
131   F80F 18 CE            JR other
132   F811              found:
133   F811 79               LD A,C
134   F812 21 AD F7         LD HL, rtab
135   F815 CB 21            SLA C
136   F817 59               LD E,C
137   F818 16 00            LD D,0x0
138   F81A 19               ADD HL, DE
139   F81B 5E               LD E, (HL)
140   F81C 23               INC HL
141   F81D 56               LD D,(HL)
142   F81E EB               EX DE,HL
143   F81F 32 B0 5C         LD (var02),A
144   F822 E9               JP (HL)
145   F823
146   F823              comm:
147   F823              nexts:
148   F823              roner:
149   F823              offer:
150   F823              rcopy:
151   F823
152   F823 00 00 00...      DS 0xFA32-$,0  // 64050
153   FA32              rnew:
154   FA32 D7               RST CALROM1
155   FA33 20 00            DEFW NEXCHA     ; Call NEXT-CHAR at ROM1. Test for keypress, incrementing CH-ADD
156   FA35 CD B7 05         CALL 0x05B7     ; ST-END Confirm end of statement and exit from ROM2 into ROM1 editor
157   FA38 D7               RST CALROM1
158   FA39 41 FA            DEFW new        ; copy NEW from ROM1 into Graphic character buffer
159   FA3B              retu:
160   FA3B C3 5F FA         JP rtu          ; Jump over NEW copy code and resume
161   FA3E              retv:
162   FA3E C3 7B FA         JP rtv
163   FA41              new:                ; Copy 1st part of fake NEW into grchbuf
164   FA41 11 58 FF         LD DE, grchbuf  ; Graphic character USR"a" buffer address
165   FA44 21 B7 11         LD HL, 0x11B7   ; NEW ROM1 1st routine block
166   FA47 01 47 00         LD BC, 0x0047   ; transfer 0x47 bytes 1st segment
167   FA4A ED B0            LDIR
168   FA4C 21 19 12         LD HL, 0x1219   ; NEW ROM1 second block
169   FA4F 01 5D 00         LD BC, 0x005D   ; transfer 0x5D bytes
170   FA52 ED B0            LDIR
171   FA54 21 3B FA         LD HL, retu     ; add rtu return address at the end of fake NEW copy 1st part
172   FA57 01 03 00         LD BC, 0x03     ; transfer 3 bytes
173   FA5A ED B0            LDIR
174   FA5C C3 58 FF         JP grchbuf      ; execute 1st part of fake NEW
175   FA5F              rtu:
176   FA5F 11 58 FF         LD DE, grchbuf
177   FA62 21 76 12         LD HL ,0x1276
178   FA65 01 2A 00         LD BC, 0x002A
179   FA68 ED B0            LDIR
180   FA6A 21 3E FA         LD HL, retv     ; add rtv return address at the end of fake NEW copy 2nd part
181   FA6D 01 03 00         LD BC, 0x03
182   FA70 ED B0            LDIR
183   FA72 21 89 FD         LD HL, pomsg
184   FA75 22 79 FF         LD (grchbuf+0x21),HL
185   FA78 C3 58 FF         JP grchbuf      ; execute 2nd part of fake NEW with pomsg welcome message and resume at rtv
186   FA7B              rtv:
187   FA7B CF               RST 0x08        ; Call Hook at ROM2
188   FA7C 31               DEFB 0x31       ; Creates the new system variables used by the Interface 1
189   FA7D 21 3C F7         LD HL, exten
190   FA80 22 B7 5C         LD (VECTOR),HL  ; Load our "exten" new command service routine into VECTOR System Variable
191   FA83 21 FF FF         LD HL, 0xFFFF   ; Copy Graphic Characters from ROM1 into used grchbuf top-down
192   FA86 11 AF 3E         LD DE, 0x3EAF
193   FA89 01 A0 00         LD BC,0x00A0
194   FA8C EB               EX DE,HL
195   FA8D ED B8            LDDR
196   FA8F 3A 6A 5C         LD A,(0x5C6A)   ; Activate Uppercase to easy new command
197   FA92 CB DF            SET 3,A
198   FA94 32 6A 5C         LD (0x5C6A),A   ; FLAGS2 00000100 (Set CAPS LOCK)
199   FA97 3E 00            LD A,0x00
200   FA99 32 91 5C         LD (0x5C91),A   ; P-FLAGS 01011000 (Paper 9 temp, Ink 9 temp, Inverse permanent)
201   FA9C C3 A9 12         JP 0x12A9       ; MAIN-1 tranfer back control to ROM1 main execution loop
202   FA9F              ; .TR command
203   FA9F              rtr:
204   FA9F D7               RST CALROM1
205   FAA0 20 00            DEFW NEXCHA
206   FAA2 FE 3E            CP ">"
207   FAA4 20 07            JR NZ,nogre
208   FAA6 3E 09            LD A,9
209   FAA8 32 B0 5C         LD (0x5CB0),A
210   FAAB 18 05            JR ftr
211   FAAD              nogre:
212   FAAD FE 3C            CP "<"
213   FAAF              trer:
214   FAAF C2 F0 01         JP NZ,0x01F0
215   FAB2              ftr:
216   FAB2 D7               RST CALROM1
217   FAB3 20 00            DEFW NEXCHA
218   FAB5 D7               RST CALROM1
219   FAB6 8C 1C            DEFW 0x1C8C
220   FAB8 FE 2C            CP ","
221   FABA 20 F3            JR NZ,trer
222   FABC D7               RST CALROM1
223   FABD 20 00            DEFW NEXCHA
224   FABF D7               RST CALROM1
225   FAC0 82 1C            DEFW 0x1C82
226   FAC2 CD B7 05         CALL 0x05B7
227   FAC5              traf:
228   FAC5 D7               RST CALROM1
229   FAC6 99 1E            DEFW 0x1E99
230   FAC8 C5               PUSH BC
231   FAC9 D7               RST CALROM1
232   FACA F1 2B            DEFW 0x2BF1
233   FACC E1               POP HL
234   FACD 3A B0 5C         LD A,(0x5CB0)
235   FAD0 FE 08            CP 0x08
236   FAD2 28 01            JR Z,sense
237   FAD4 EB               EX DE,HL
238   FAD5              sense:
239   FAD5 ED B0            LDIR
240   FAD7 C3 C1 05         JP 0x05C1
241   FADA              rren:
242   FADA D7               RST CALROM1
243   FADB 20 00            DEFW NEXCHA
244   FADD D7               RST CALROM1
245   FADE 7A 1C            DEFW 0x1C7A
246   FAE0 CD B7 05         CALL 0x5B7
247   FAE3 3A B0 5C         LD A,(0x5CB0)
248   FAE6 FE 06            CP 6
249   FAE8 C2 7C FC         JP NZ,rdel
250   FAEB D7               RST CALROM1
251   FAEC F1 FA            DEFW renum
252   FAEE C3 C1 05         JP 0x5C1
253   FAF1              renum:
254   FAF1 CD 99 1E         CALL 0x1E99
255   FAF4 C5               PUSH BC
256   FAF5 E1               POP HL
257   FAF6 22 02 5B         LD (0x5B02),HL
258   FAF9 CD 99 1E         CALL 0x1E99
259   FAFC C5               PUSH BC
260   FAFD E1               POP HL
261   FAFE 22 00 5B         LD (0x5B00),HL
262   FB01 7C               LD A,H
263   FB02 B5               OR L
264   FB03 C8               RET Z
265   FB04 2A 02 5B         LD HL,(0x5B02)
266   FB07 7C               LD A,H
267   FB08 B5               OR L
268   FB09 C8               RET Z
269   FB0A 2A 53 5C         LD HL,(0x5C53)
270   FB0D ED 5B 00 5B      LD DE,(0x5B00)
271   FB11              nxtln:
272   FB11 CD 70 FC         CALL chck
273   FB14 30 16            JR NC,fndgt
274   FB16 46               LD B,(HL)
275   FB17 72               LD (HL),D
276   FB18 23               INC HL
277   FB19 4E               LD C,(HL)
278   FB1A 73               LD (HL),E
279   FB1B 23               INC HL
280   FB1C 71               LD (HL),C
281   FB1D 34               INC (HL)
282   FB1E 70               LD (HL),B
283   FB1F 23               INC HL
284   FB20 E5               PUSH HL
285   FB21 2A 02 5B         LD HL,(0x5B02)
286   FB24 19               ADD HL,DE
287   FB25 EB               EX DE,HL
288   FB26 E1               POP HL
289   FB27 CD 65 FC         CALL eol
290   FB2A 18 E5            JR nxtln
291   FB2C              fndgt:
292   FB2C 2A 33 5C         LD HL,(0x5C33)
293   FB2F 23               INC HL
294   FB30 23               INC HL
295   FB31 23               INC HL
296   FB32 23               INC HL
297   FB33              srch:
298   FB33 CD 0F FC         CALL fnd
299   FB36 D2 DC FB         JP NC,rstr
300   FB39 54               LD D,H
301   FB3A 5D               LD E,L
302   FB3B 06 00            LD B,0x0
303   FB3D              nxtdg:
304   FB3D 04               INC B
305   FB3E 23               INC HL
306   FB3F 7E               LD A,(HL)
307   FB40 FE 2C            CP ","
308   FB42 20 01            JR NZ,cntn
309   FB44              fndnx:
310   FB44 EB               EX DE,HL
311   FB45              cntn:
312   FB45 18 EC            JR srch
313   FB47 FE 0E            CP 0x0E ; 14 id of floating point
314   FB49 20 F2            JR NZ,nxtdg
315   FB4B 23               INC HL
316   FB4C 23               INC HL
317   FB4D 23               INC HL
318   FB4E 23               INC HL
319   FB4F 23               INC HL
320   FB50 23               INC HL
321   FB51 7E               LD A,(HL)
322   FB52 FE 3A            CP ":"
323   FB54 28 04            JR Z,fou
324   FB56 FE 0D            CP 0x0D ; 13
325   FB58 20 EA            JR NZ,fndnx
326   FB5A              fou:
327   FB5A 78               LD A,B
328   FB5B              cmpr:
329   FB5B FE 04            CP 0X04
330   FB5D 28 10            JR Z,clclt
331   FB5F 20 E3            JR NZ,fndnx
332   FB61 D5               PUSH DE
333   FB62 62               LD H,D
334   FB63 6B               LD L,E
335   FB64 F5               PUSH AF
336   FB65 3E 30            LD A,"0"
337   FB67 CD 00 0F         CALL 0X0F00
338   FB6A F1               POP AF
339   FB6B 3C               INC A
340   FB6C D1               POP DE
341   FB6D 18 EC            JR cmpr
342   FB6F              clclt:
343   FB6F 42               LD B,D
344   FB70 3B               DEC SP      ; LD C,E
345   FB71 D5               PUSH DE
346   FB72 21 00 00         LD HL,0x0000
347   FB75 11 E8 03         LD DE,0x03E8    ; 1000
348   FB78 CD 06 FC         CALL ladd
349   FB7B 11 64 00         LD DE, 0x0064   ; 100
350   FB7E CD 06 FC         CALL ladd
351   FB81 1E 0A            LD E,0x0A       ; 10
352   FB83 CD 06 FC         CALL ladd
353   FB86 0A               LD A,(BC)
354   FB87 D6 30            SUB "0"
355   FB89 5F               LD E,A
356   FB8A 19               ADD HL,DE
357   FB8B 44               LD B,H
358   FB8C 4D               LD C,L
359   FB8D 2A 53 5C         LD HL,(0x5C53)
360   FB90              fndln:
361   FB90 23               INC HL
362   FB91 23               INC HL
363   FB92              eop:
364   FB92 CD 70 FC         CALL chck
365   FB95 38 03            JR C,xsts
366   FB97 E1               POP HL
367   FB98 18 99            JR srch
368   FB9A              xsts:
369   FB9A 7E               LD A,(HL)
370   FB9B B9               CP C
371   FB9C 30 07            JR NC,nxtbt
372   FB9E 23               INC HL
373   FB9F              wrng:
374   FB9F 23               INC HL
375   FBA0 CD 65 FC         CALL eol
376   FBA3 18 EB            JR fndln
377   FBA5              nxtbt:
378   FBA5 23               INC HL
379   FBA6 7E               LD A,(HL)
380   FBA7 B8               CP B
381   FBA8 38 F5            JR C,wrng
382   FBAA 2B               DEC HL
383   FBAB 2B               DEC HL
384   FBAC 4E               LD C,(HL)
385   FBAD 2B               DEC HL
386   FBAE 66               LD H,(HL)
387   FBAF 69               LD L,C
388   FBB0 C1               POP BC
389   FBB1 C5               PUSH BC
390   FBB2 E5               PUSH HL
391   FBB3 11 E8 03         LD DE,0X03E8 ; 1000
392   FBB6 CD F8 FB         CALL nsrt
393   FBB9 11 64 00         LD DE,0x0064
394   FBBC CD F8 FB         CALL nsrt
395   FBBF 1E 0A            LD E,0x0A
396   FBC1 CD F8 FB         CALL nsrt
397   FBC4 1E 01            LD E,1
398   FBC6 CD F8 FB         CALL nsrt
399   FBC9 03               INC BC
400   FBCA 97               SUB A
401   FBCB 02               LD (BC),A
402   FBCC 03               INC BC
403   FBCD 02               LD (BC),A
404   FBCE 03               INC BC
405   FBCF E1               POP HL
406   FBD0 7D               LD A,L
407   FBD1 02               LD (BC),A
408   FBD2 03               INC BC
409   FBD3 7C               LD A,H
410   FBD4 02               LD (BC),A
411   FBD5 03               INC BC
412   FBD6 97               SUB A
413   FBD7 02               LD (BC),A
414   FBD8 E1               POP HL
415   FBD9 C3 33 FB         JP srch
416   FBDC              rstr:
417   FBDC 2A 53 5C         LD HL,(0x5C53)
418   FBDF              fllw:
419   FBDF 23               INC HL
420   FBE0 23               INC HL
421   FBE1 CD 70 FC         CALL chck
422   FBE4 D0               RET NC
423   FBE5 44               LD B,H
424   FBE6 4D               LD C,L
425   FBE7 CD 65 FC         CALL eol
426   FBEA E5               PUSH HL
427   FBEB A7               AND A
428   FBEC ED 42            SBC HL,BC
429   FBEE 2B               DEC HL
430   FBEF 2B               DEC HL
431   FBF0 7D               LD A,L
432   FBF1 02               LD (BC),A
433   FBF2 03               INC BC
434   FBF3 7C               LD A,H
435   FBF4 02               LD (BC),A
436   FBF5 E1               POP HL
437   FBF6 18 E7            JR fllw
438   FBF8              nsrt:
439   FBF8 3E 30            LD A,0x30   ; +40
440   FBFA              sbtr:
441   FBFA A7               AND A
442   FBFB ED 52            SBC HL,DE
443   FBFD 38 03            JR C,poke
444   FBFF 3C               INC A
445   FC00 18 F8            JR sbtr
446   FC02              poke:
447   FC02 19               ADD HL,DE
448   FC03 02               LD (BC),A
449   FC04 03               INC BC
450   FC05 C9               RET
451   FC06              ladd:
452   FC06 0A               LD A,(BC)
453   FC07 03               INC BC
454   FC08 D6 2F            SUB 0x2F    ;  +47
455   FC0A              repea:
456   FC0A 3D               DEC A
457   FC0B C8               RET Z
458   FC0C 19               ADD HL,DE
459   FC0D 18 FB            JR repea
460   FC0F              fnd:
461   FC0F 7E               LD A,(HL)
462   FC10 CD 70 FC         CALL chck
463   FC13 D0               RET NC
464   FC14 FE EA            CP 0xEA
465   FC16 20 0D            JR NZ,ntrem
466   FC18              fntr:
467   FC18 23               INC HL
468   FC19 7E               LD A,(HL)
469   FC1A FE 0D            CP 0x0D     ; 13
470   FC1C 20 FA            JR NZ,fntr
471   FC1E              ncrs:
472   FC1E 23               INC HL
473   FC1F 23               INC HL
474   FC20 23               INC HL
475   FC21 23               INC HL
476   FC22 23               INC HL
477   FC23 18 EA            JR fnd
478   FC25              ntrem:
479   FC25 FE 22            CP 0x22
480   FC27 20 09            JR NZ,nstrg
481   FC29              nxchr:
482   FC29 23               INC HL
483   FC2A 7E               LD A,(HL)
484   FC2B FE 22            CP 0X22
485   FC2D 20 FA            JR NZ, nxchr
486   FC2F 23               INC HL
487   FC30 18 DD            JR fnd
488   FC32              nstrg:
489   FC32 FE 0D            CP 0x0D
490   FC34 28 E8            JR Z,ncrs
491   FC36 CD B6 18         CALL 0x18B6
492   FC39 28 D4            JR Z,fnd
493   FC3B FE ED            CP 0xED
494   FC3D 28 1B            JR Z,chkdg
495   FC3F FE EC            CP 0xEC
496   FC41 28 17            JR Z,chkdg
497   FC43 FE F7            CP 0xF7
498   FC45 28 13            JR Z,chkdg
499   FC47 FE F0            CP 0xF0
500   FC49 28 0F            JR Z,chkdg
501   FC4B FE E5            CP 0xE5
502   FC4D 28 0B            JR Z,chkdg
503   FC4F FE E1            CP 0xE1
504   FC51 28 07            JR Z,chkdg
505   FC53 FE CA            CP 0xCA
506   FC55 28 03            JR Z,chkdg
507   FC57 23               INC HL
508   FC58 18 B5            JR fnd
509   FC5A              chkdg:
510   FC5A 23               INC HL
511   FC5B 7E               LD A,(HL)
512   FC5C FE 30            CP 0x30
513   FC5E 38 AF            JR C,fnd ; JR Z,fnd
514   FC60 FE 3A            CP 0x3A
515   FC62 30 AB            JR NC,fnd
516   FC64 C9               RET
517   FC65              eol:
518   FC65 7E               LD A,(HL)
519   FC66              again:
520   FC66 CD B6 18         CALL 0x18B6
521   FC69 28 FB            JR Z,again
522   FC6B FE 0D            CP 0x0D
523   FC6D 23               INC HL
524   FC6E 20 F5            JR NZ,eol
525   FC70              chck:
526   FC70 E5               PUSH HL
527   FC71 D5               PUSH DE
528   FC72                  ;LD DE,(0x4B5B)
529   FC72 ED 5B 4B 5C      DEFB 0xED,0x5B,0x4B,0x5C
530   FC76 A7               AND A
531   FC77 ED 52            SBC HL,DE
532   FC79 D1               POP DE
533   FC7A E1               POP HL
534   FC7B C9               RET
535   FC7C
536   FC7C              rdel:
537   FC7C D7               RST CALROM1
538   FC7D 82 FC            DEFW delet
539   FC7F C3 C1 05         JP 0x05C1
540   FC82              delet:
541   FC82 CD 99 1E         CALL 0x1E99
542   FC85 C5               PUSH BC
543   FC86 CD 99 1E         CALL 0x1E99
544   FC89 C5               PUSH BC
545   FC8A E1               POP HL
546   FC8B D1               POP DE
547   FC8C 7C               LD A,H
548   FC8D B5               OR L
549   FC8E C8               RET Z
550   FC8F 7A               LD A,D
551   FC90 B3               OR E
552   FC91 C8               RET Z
553   FC92 D5               PUSH DE
554   FC93 CD 6E 19         CALL 0x196E
555   FC96 E3               EX (SP),HL
556   FC97 23               INC HL
557   FC98 CD 6E 19         CALL 0x196E
558   FC9B D1               POP DE
559   FC9C A7               AND A
560   FC9D ED 52            SBC HL, DE
561   FC9F C8               RET Z
562   FCA0 D8               RET C
563   FCA1 44               LD B,H
564   FCA2 4D               LD C,L
565   FCA3 19               ADD HL,DE
566   FCA4 EB               EX DE,HL
567   FCA5 CD E8 19         CALL 0x19E8
568   FCA8 C9               RET
569   FCA9
570   FCA9              rfnd:               ; .FND Find string in Basic lines command
571   FCA9 D7               RST CALROM1
572   FCAA 20 00            DEFW NEXCHA     ; Parse a character
573   FCAC D7               RST CALROM1        ; Parse to end of string
574   FCAD 8C 1C            DEFW 0x1C8C
575   FCAF CD B7 05         CALL 0x05B7     ; Exit editor
576   FCB2 D7               RST CALROM1
577   FCB3 E3 FC            DEFW sr0        ; call sr0 in ROM1 0xFCE3
578   FCB5 C3 C1 05         JP 0x05C1       ; command exit
579   FCB8              rcha:               ; .CHA Change string command
580   FCB8 D7               RST CALROM1
581   FCB9 20 00            DEFW NEXCHA     ; Parse next character
582   FCBB D7               RST CALROM1
583   FCBC 8C 1C            DEFW 0x1C8C     ; Parse to end of string in ROM1
584   FCBE FE CC            CP 0xCC
585   FCC0 C2 F0 01         JP NZ,0x01F0    ; Error if  we do not have a 'TO' separator
586   FCC3 D7               RST CALROM1
587   FCC4 20 00            DEFW NEXCHA     ; Next character
588   FCC6 D7               RST CALROM1        ; Parse a character string
589   FCC7 8C 1C            DEFW 0x1C8C
590   FCC9 CD B7 05         CALL 0x05B7     ; Exit editor
591   FCCC D7               RST CALROM1        ; call ch0 with ROM1
592   FCCD D2 FC            DEFW ch0
593   FCCF C3 C1 05         JP 0x05C1       ; Command exit
594   FCD2              ch0:
595   FCD2 CD F1 2B         CALL 0x2BF1     ; DE = last string start
596   FCD5 79               LD A,C          ; BC = last string length
597   FCD6 FE 00            CP 0            ; length is 0?
598   FCD8 C8               RET Z           ; Resume Basic
599   FCD9 21 00 5B         LD HL,0x5B00
600   FCDC 71               LD (HL),C       ; second string length into 0x5B00
601   FCDD 23               INC HL
602   FCDE 70               LD (HL),B
603   FCDF 23               INC HL
604   FCE0 EB               EX DE, HL       ; Copy in 0x5B02 second string
605   FCE1 ED B0            LDIR
606   FCE3              sr0:
607   FCE3 CD F1 2B         CALL 0x2BF1
608   FCE6 D5               PUSH DE
609   FCE7 DD E1            POP IX
610   FCE9 79               LD A,C
611   FCEA 32 81 5C         LD (var01),A
612   FCED              sr1:
613   FCED FD CB 02 86      RES 0,(IY+2)
614   FCF1 2A 53 5C         LD HL,(0x5C53)
615   FCF4              sr2:
616   FCF4 3A 81 5C         LD A,(var01)
617   FCF7 5F               LD E,A
618   FCF8 FE 00            CP 0x0
619   FCFA C8               RET Z
620   FCFB E5               PUSH HL
621   FCFC              sr3:
622   FCFC DD E5            PUSH IX
623   FCFE C1               POP BC
624   FCFF 16 00            LD D,0x0
625   FD01 23               INC HL
626   FD02 23               INC HL
627   FD03 23               INC HL
628   FD04              sr4:
629   FD04 23               INC HL
630   FD05 D5               PUSH DE
631   FD06 ED 5B 4B 5C      LD DE,(0x5C4B)
632   FD0A AF               XOR A
633   FD0B A7               AND A
634   FD0C ED 52            SBC HL,DE
635   FD0E 19               ADD HL,DE
636   FD0F D1               POP DE
637   FD10 38 02            JR C,sr5
638   FD12 E1               POP HL
639   FD13 C9               RET
640   FD14              sr5:
641   FD14 7E               LD A,(HL)
642   FD15 FE 0D            CP 0x0D
643   FD17 20 05            JR NZ,sr6
644   FD19 23               INC HL
645   FD1A C1               POP BC
646   FD1B E5               PUSH HL
647   FD1C 18 DE            JR sr3
648   FD1E              sr6:
649   FD1E CD B6 18         CALL 0x18B6
650   FD21 20 11            JR NZ,sr8
651   FD23 2B               DEC HL
652   FD24              sr7:
653   FD24 7A               LD A,D
654   FD25 FE 00            CP 0x0
655   FD27 28 04            JR Z,sr71
656   FD29 42               LD B,D
657   FD2A              sr70:
658   FD2A 2B               DEC HL
659   FD2B 10 FD            DJNZ sr70
660   FD2D              sr71:
661   FD2D DD E5            PUSH IX
662   FD2F C1               POP BC
663   FD30 16 00            LD D,0
664   FD32 18 D0            JR sr4
665   FD34              sr8:
666   FD34 0A               LD A,(BC)
667   FD35 BE               CP (HL)
668   FD36 20 EC            JR NZ,sr7
669   FD38 03               INC BC
670   FD39 14               INC D
671   FD3A 7A               LD A,D
672   FD3B BB               CP E
673   FD3C 20 C6            JR NZ,sr4
674   FD3E 3A B0 5C         LD A,(0x5CB0)
675   FD41 FE 0A            CP 0x0A ; Jump if command is .CHA
676   FD43 20 12            JR NZ,ch1
677   FD45              sr9:
678   FD45 E1               POP HL
679   FD46 E5               PUSH HL
680   FD47 46               LD B,(HL)
681   FD48 23               INC HL
682   FD49 4E               LD C,(HL)
683   FD4A ED 43 49 5C      LD (0x5C49),BC
684   FD4E E1               POP HL
685   FD4F CD 55 18         CALL 0x1855
686   FD52 3E 0D            LD A,0x0D
687   FD54 D7               RST CALROM1
688   FD55 18 9D            JR sr2
689   FD57              ch1:
690   FD57 7B               LD A,E
691   FD58 FE 01            CP 0x1
692   FD5A 28 05            JR Z,ch3
693   FD5C 3D               DEC A
694   FD5D 47               LD B,A
695   FD5E              ch2:
696   FD5E 2B               DEC HL
697   FD5F 10 FD            DJNZ ch2
698   FD61              ch3:
699   FD61 3A 00 5B         LD A,(0x5B00)
700   FD64 BB               CP E
701   FD65 28 08            JR Z,ch4
702   FD67 38 06            JR C,ch4
703   FD69 7B               LD A,E
704   FD6A 32 00 5B         LD (0x5B00),A
705   FD6D 18 00            JR ch4
706   FD6F              ch4:
707   FD6F EB               EX DE,HL
708   FD70 21 02 5B         LD HL,0x5B02
709   FD73 06 00            LD B,0x0
710   FD75 3A 00 5B         LD A,(0x5B00)
711   FD78 4F               LD C,A
712   FD79 ED B0            LDIR
713   FD7B EB               EX DE,HL
714   FD7C 2B               DEC HL
715   FD7D DD E5            PUSH IX
716   FD7F C1               POP BC
717   FD80 3A 81 5C         LD A,(0x5C81)
718   FD83 16 00            LD D,0
719   FD85 5F               LD E,A
720   FD86 C3 04 FD         JP sr4
721   FD89              pomsg:
722   FD89 A0               DEFB 0xA0
723   FD8A 4D 69 63 72      DEFB "Micro Basic O.S. ANC SPAIN "
723   FD8E 6F 20 42 61
723   FD92 73 69 63 20
723   FD96 4F 2E 53 2E
723   FD9A 20 41 4E 43
723   FD9E 20 53 50 41
723   FDA2 49 4E 20
724   FDA5 7F               DEFB 0x7F
725   FDA6 31 39 38         DEFB "198"
726   FDA9 B4               DEFB 0xB4
727   FDAA              raof:
728   FDAA D7               RST CALROM1
729   FDAB 20 00            DEFW NEXCHA
730   FDAD CD B7 05         CALL 0x05B7
731   FDB0 F3               DI
732   FDB1 3E 3E            LD A,0x3E
733   FDB3 ED 47            LD I,A
734   FDB5 ED 56            IM 1
735   FDB7 FB               EI
736   FDB8 C3 C1 05         JP 0x05C1
737   FDBB              raon:
738   FDBB D7               RST CALROM1
739   FDBC 20 00            DEFW NEXCHA
740   FDBE CD B7 05         CALL 0x05B7
741   FDC1 F3               DI
742   FDC2 21 4A F7         LD HL,vecin
743   FDC5 11 69 FE         LD DE,0xFE69
744   FDC8 01 03 00         LD BC,0x0003
745   FDCB ED B0            LDIR
746   FDCD 3E 09            LD A,0x09
747   FDCF ED 47            LD I,A
748   FDD1 ED 5E            IM 2
749   FDD3 FB               EI
750   FDD4 C3 C1 05         JP 0x05C1
751   FDD7              trac0:
752   FDD7 00               DEFB 0x0
753   FDD8              inter:
754   FDD8 FF               RST 0x038
755   FDD9 F3               DI
756   FDDA F5               PUSH AF
microbasic.asm(757): warning: Accessing low memory address 0x0000, is it ok?: LD A,(0x0000)   
757   FDDB 3A 00 00         LD A,(0x0000)   ; Identify which ROM is active
758   FDDE FE E1            CP 0xE1
759   FDE0 20 03            JR NZ,rom1      ; If we are in ROM2, just exit from ISR
760   FDE2 F1               POP AF
761   FDE3 FB               EI
762   FDE4 C9               RET
763   FDE5              rom1:
764   FDE5 E5               PUSH HL
765   FDE6 D5               PUSH DE
766   FDE7 C5               PUSH BC
767   FDE8 3A D7 FD         LD A,(trac0)
768   FDEB FE 00            CP 0x0
769   FDED 20 27            JR NZ,trac4
770   FDEF 3A 82 5C         LD A,(0x5C82)   ; ECHO-E Column &line number. End of input
771   FDF2 FE 20            CP 0x20
772   FDF4 20 6D            JR NZ,trac3
773   FDF6 3A 83 5C         LD A,(0x5C83)   ;
774   FDF9 FE 17            CP 0x17
775   FDFB 20 66            JR NZ,trac3
776   FDFD 21 08 5C         LD HL,0x5C08    ; Last key pressed
777   FE00 7E               LD A,(HL)
778   FE01 FE 0C            CP 0x0C
779   FE03 28 5E            JR Z,trac3
780   FE05 21 04 5C         LD HL,0x5C04
781   FE08 7E               LD A,(HL)
782   FE09 FE 0D            CP 0x0D
783   FE0B 28 04            JR Z,twrit
784   FE0D FE FF            CP 0xFF
785   FE0F 20 52            JR NZ,trac3
786   FE11              twrit:
787   FE11 3E 04            LD A,0x04
788   FE13 32 D7 FD         LD (trac0),A
789   FE16              trac4:
790   FE16 3A D7 FD         LD A,(trac0)
791   FE19 3D               DEC A
792   FE1A 32 D7 FD         LD (trac0),A
793   FE1D 2A 49 5C         LD HL,(0x5C49)
794   FE20 11 0A 00         LD DE,0x000A
795   FE23 19               ADD HL,DE
796   FE24 01 10 FC         LD BC,0xFC10
797   FE27 CD 4A FE         CALL trac1
798   FE2A FE 03            CP 0x03
799   FE2C 28 35            JR Z,trac3
800   FE2E 01 9C FF         LD BC,0xFF9C
801   FE31 CD 4A FE         CALL trac1
802   FE34 FE 02            CP 0x02
803   FE36 28 2B            JR Z,trac3
804   FE38 01 F6 FF         LD BC,0xFFF6
805   FE3B CD 4A FE         CALL trac1
806   FE3E FE 01            CP 0x01
807   FE40 28 21            JR Z,trac3
808   FE42 01 FF FF         LD BC,0xFFFF
809   FE45 CD 4A FE         CALL trac1
810   FE48 18 19            JR trac3
811   FE4A              trac1:
812   FE4A AF               XOR A
813   FE4B              trac2:
814   FE4B 09               ADD HL,BC
815   FE4C 3C               INC A
816   FE4D 38 FC            JR C,trac2
817   FE4F ED 42            SBC HL,BC
818   FE51 3D               DEC A
819   FE52 C6 30            ADD A,0x30
820   FE54 32 08 5C         LD (0x5C08),A
821   FE57 3A 3B 5C         LD A,(0x5C3B)
822   FE5A CB EF            SET 5,A
823   FE5C 32 3B 5C         LD (0x5C3B),A
824   FE5F 3A D7 FD         LD A,(trac0)
825   FE62 C9               RET
826   FE63              trac3:
827   FE63 C1               POP BC
828   FE64 D1               POP DE
829   FE65 E1               POP HL
830   FE66 F1               POP AF
831   FE67 FB               EI
832   FE68 C9               RET
833   FE69              lbjp:
834   FE69 FE FE FE FE      DEFB 0xFE,0xFE,0xFE,0xFE
835   FE6D              ; Screen$
836   FE6D              ; gap
837   FE6D 00 00 00...      DS 0xFEF0-$
838   FEF0              rsave:
839   FEF0 3E F8            LD A,0xF8
840   FEF2 18 0A            JR sacon
841   FEF4              rload:
842   FEF4 3E EF            LD A,0xEF
843   FEF6 18 06            JR sacon
844   FEF8              rvery:
845   FEF8 3E D6            LD A,0xD6
846   FEFA 18 02            JR sacon
847   FEFC              rmerg:
848   FEFC 3E D5            LD A,0xD5
849   FEFE              sacon:
850   FEFE 01 0A 00         LD BC,0x0A
851   FF01 11 39 FF         LD DE,texcm
852   FF04 18 1A            JR ampli
853   FF06              rmove:
854   FF06 3E D1            LD A,0xD1
855   FF08 18 06            JR mocon
856   FF0A              reras:
857   FF0A 3E D2            LD A,0xD2
858   FF0C 18 02            JR mocon
859   FF0E              rform:
860   FF0E 3E D0            LD a,0xD0
861   FF10              mocon:
862   FF10 11 43 FF         LD DE, texsa
863   FF13 01 09 00         LD BC,0x9
864   FF16 18 08            JR ampli
865   FF18              ropen:
866   FF18 3E D3            LD A,0xD3
867   FF1A 11 4C FF         LD DE,texop
868   FF1D 01 0B 00         LD BC, 0x0B
869   FF20              ampli:
870   FF20 D5               PUSH DE
871   FF21 C5               PUSH BC
872   FF22 12               LD (DE),A
873   FF23 D7               RST CALROM1
874   FF24 20 00            DEFW NEXCHA
875   FF26 C1               POP BC
876   FF27 C5               PUSH BC
877   FF28 0B               DEC BC
878   FF29 D7               RST CALROM1
879   FF2A 55 16            DEFW 0x1655
880   FF2C C1               POP BC
881   FF2D D1               POP DE
882   FF2E EB               EX DE,HL
883   FF2F ED B0            LDIR
884   FF31 EB               EX DE,HL
885   FF32 2B               DEC HL
886   FF33 22 5B 5C         LD (0x5C5B),HL
887   FF36 C3 F0 01         JP 0x01F0
888   FF39              texcm:
889   FF39 F8               DEFB 0xF8
890   FF3A              texmd:
891   FF3A 2A 22 6D 22      DEFB "*",0x22,"m",0x22,0x3B,"1",0x3B,0x22,0x22
891   FF3E 3B 31 3B 22
891   FF42 22
892   FF43              texsa
893   FF43 D1 22 6D 22      DEFB 0xD1,0x22,"m",0x22,0x3B,"1",0x3B,0x22,0x22
893   FF47 3B 31 3B 22
893   FF4B 22
894   FF4C              texop:
895   FF4C D3 38 3B 22      DEFB 0xD3,"8",0x3B,0x22,"m",0x22,0x3B,"1",0x3B,0x22,0x22
895   FF50 6D 22 3B 31
895   FF54 3B 22 22
896   FF57
# file closed: microbasic.asm

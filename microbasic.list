# file opened: microbasic.asm
  1   0000              ; From the book "Interface 1 and Microdrive Programmin (Spanish)"
  2   0000              ; Written August 1983. Book Published 1984 under (c) Anaya Multimedia SA. ISBN 84-7614-038-X
  3   0000              ; Author: Agustin Nunez @agnuca https://github.com/agnunez/MicroBasic
  4   0000              ; Code: NonoComercial Creative Commons Internationa (CC BY-NC 4.0)
  5   0000
  6   0000                  DEVICE ZXSPECTRUM48
  7   0000              ; ROM1  rountines entry points
  8   0000
  9   0000              GETCHA EQU 0x0018
 10   0000              NEXCHA EQU 0x0020  ;
 11   0000
 12   0000              ; ROM2 (Interface 1) rountines entry points
 13   0000              CALROM1  EQU 0x10    ; Call a ROM1 routine from ROM2
 14   0000
 15   0000              ; System Variables
 16   0000              var01 EQU 0x5C81
 17   0000              var02 EQU 0x5CB0
 18   0000              inichad EQU 0x5C5D
 19   0000              RAMTOP EQU 0x5CB2
 20   0000              VECTOR  EQU 0x5CB7  ; Hook address for command extension while syntax error found
 21   0000              grchbuf EQU 0xFF58
 22   0000
 23   0000                 ORG 0xF733  ; Load binary in 63283
 24   F733              rtop EQU $-1
 25   F733 21 32 F7         LD HL,rtop      ; Load RAMTOP  with our firmware start address
 26   F736 22 B2 5C         LD (RAMTOP),HL  ; RAMTOP System Variable address
 27   F739 C3 7B FA         JP rtv          ; jump to initialization routine
 28   F73C              ;ROM1 routines entry points
 29   F73C
 30   F73C              main:
 31   F73C              exten:              ; Entry point with ROM2 active
 32   F73C D7               RST CALROM1      ; ROM2 call ROM1 at def word below
 33   F73D 18 00            DEFW GETCHA     ; GET-CHAR from ROM1 into A
 34   F73F 22 81 5C         LD (var01),HL
 35   F742 0E 00            LD C,0
 36   F744 21 4D F7         LD HL, stab
 37   F747 C3 E6 F7         JP othcm
 38   F74A              vecin:
 39   F74A C3 D8 FD         JP inter
 40   F74D              stab:
 41   F74D E3 A0            DEFB 0xE3,0xA0		; CODE "READ"
 42   F74F E5 A0            DEFB 0xE5,0xA0		; CODE "RESTORE"
 43   F751 BF A0            DEFB 0xBF,0xA0		; CODE "IN"
 44   F753 F3 A0            DEFB 0xF3,0xA0		; CODE "NEXT"
 45   F755 2E 4F 4E 45      DEFB ".ONERROR:",0xEC,0xA0	; + CODE 'GOTO'"
 45   F759 52 52 4F 52
 45   F75D 3A EC A0
 46   F760 2E 4F 46 46      DEFB ".OFFERROR",0xA0
 46   F764 45 52 52 4F
 46   F768 52 A0
 47   F76A 2E 52 45 4E      DEFB ".REN",0xA0
 47   F76E A0
 48   F76F 2E 4E 45 57      DEFB ".NEW",0xA0
 48   F773 A0
 49   F774 2E 54 52 46      DEFB ".TRF",0xA0
 49   F778 A0
 50   F779 2E 44 45 4C      DEFB ".DEL",0xA0
 50   F77D A0
 51   F77E 2E 46 4E 44      DEFB ".FND",0xA0
 51   F782 A0
 52   F783 2E 43 48 41      DEFB ".CHA",0xA0
 52   F787 A0
 53   F788 2E 41 4F 46      DEFB ".AOF",0xA0
 53   F78C A0
 54   F78D 2E 41 4F 4E      DEFB ".AON",0xA0
 54   F791 A0
 55   F792 AA A0            DEFB 0xAA,0xA0 ; CODE "SCREEN$"
 56   F794 C3 A0            DEFB 0xC3,0xA0 ; CODE "NOT"  (SAVE)
 57   F796 2D A0            DEFB 0x2D,0xA0 ; CODE "-"	 (LOAD)
 58   F798 3C A0            DEFB 0x3C,0xA0 ; CODE "<"	 (VERIFY)
 59   F79A 3E A0            DEFB 0x3E,0xA0 ; CODE ">"	 (MERGE)
 60   F79C 26 A0            DEFB 0x26,0xA0 ; CODE "&"	 (MOVE)
 61   F79E 27 A0            DEFB 0x27,0xA0 ; CODE "'"	 (ERASE)
 62   F7A0 5F A0            DEFB 0x5F,0xA0 ; CODE "_"	 (FORMAT)
 63   F7A2 24 A0            DEFB 0x24,0xA0 ; CODE "$"	 (OPEN#)
 64   F7A4              finstab:
 65   F7A4 FF               DEFB 0xFF	   ; End of command table
 66   F7A5 00 00 00 00      DEFB 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 ; Filler
 66   F7A9 00 00 00 00
 67   F7AD              rtab:		  ; command code start address table
 68   F7AD 23 F8            DEFW comm
 69   F7AF 23 F8            DEFW comm
 70   F7B1 23 F8            DEFW comm
 71   F7B3 23 F8            DEFW nexts
 72   F7B5 23 F8            DEFW roner
 73   F7B7 23 F8            DEFW offer
 74   F7B9 DA FA            DEFW rren
 75   F7BB 32 FA            DEFW rnew
 76   F7BD 23 F8            DEFW rtr
 77   F7BF DA FA            DEFW rren
 78   F7C1 A9 FC            DEFW rfnd
 79   F7C3 B8 FC            DEFW rcha
 80   F7C5 AA FD            DEFW raof
 81   F7C7 BB FD            DEFW raon
 82   F7C9 23 F8            DEFW rcopy
 83   F7CB F0 FE            DEFW rsave
 84   F7CD F4 FE            DEFW rload
 85   F7CF F8 FE            DEFW rvery
 86   F7D1 FC FE            DEFW rmerg
 87   F7D3 06 FF            DEFW rmove
 88   F7D5 0A FF            DEFW reras
 89   F7D7 0E FF            DEFW rform
 90   F7D9              finrtab
 91   F7D9 18 FF            DEFW ropen
 92   F7DB              rlibre:
 93   F7DB 00 00 00 00      DEFB 0x0,0x0,0x0,0x0
 94   F7DF              other:
 95   F7DF C5               PUSH BC
 96   F7E0 E5               PUSH HL
 97   F7E1 D7               RST CALROM1 // Call NEXCHA of ROM1 from ROM2
 98   F7E2 20 00            DEFW NEXCHA  // NEXT-CHAR from ROM1 incrementing CH-ADD
 99   F7E4 E1               POP HL
100   F7E5 C1               POP BC
101   F7E6              othcm:
102   F7E6 46               LD B,(HL)
103   F7E7 B8               CP B
104   F7E8 28 1E            JR Z, mat1
105   F7EA 47               LD B,A
106   F7EB              nmat1:
107   F7EB 23               INC HL
108   F7EC 7E               LD A,(HL)
109   F7ED FE FF            CP 0xFF
110   F7EF 28 14            JR Z, taber
111   F7F1 FE A0            CP 0xA0
112   F7F3 20 F6            JR NZ, nmat1
113   F7F5 23               INC HL
114   F7F6 78               LD A,B
115   F7F7 E5               PUSH HL
116   F7F8 2A 81 5C         LD HL,(var01)
117   F7FB 22 5D 5C         LD (inichad),HL
118   F7FE D7               RST CALROM1
119   F7FF 18 00            DEFW GETCHA         ; GET-CHAR at ROM1
120   F801 E1               POP HL
121   F802 0C               INC C
122   F803 18 E1            JR othcm
123   F805              taber:
124   F805 C3 F0 01         JP 0x01F0
125   F808              mat1:
126   F808 47               LD B,A
127   F809 23               INC HL
128   F80A 7E               LD A, (HL)
129   F80B FE A0            CP 0xA0
130   F80D 28 02            JR Z, found
131   F80F 18 CE            JR other
132   F811              found:
133   F811 79               LD A,C
134   F812 21 AD F7         LD HL, rtab
135   F815 CB 21            SLA C
136   F817 59               LD E,C
137   F818 16 00            LD D,0x0
138   F81A 19               ADD HL, DE
139   F81B 5E               LD E, (HL)
140   F81C 23               INC HL
141   F81D 56               LD D,(HL)
142   F81E EB               EX DE,HL
143   F81F 32 B0 5C         LD (var02),A
144   F822 E9               JP (HL)
145   F823
146   F823              comm:
147   F823              nexts:
148   F823              roner:
149   F823              offer:
150   F823              rtr:
151   F823              rcopy:
152   F823
153   F823 00 00 00...      DS 0xFA32-$,0  // 64050
154   FA32              rnew:
155   FA32 D7               RST CALROM1
156   FA33 20 00            DEFW NEXCHA     ; Call NEXT-CHAR at ROM1. Test for keypress, incrementing CH-ADD
157   FA35 CD B7 05         CALL 0x05B7     ; ST-END Confirm end of statement and exit from ROM2 into ROM1 editor
158   FA38 D7               RST CALROM1
159   FA39 41 FA            DEFW new        ; copy NEW from ROM1 into Graphic character buffer
160   FA3B              retu:
161   FA3B C3 5F FA         JP rtu          ; Jump over NEW copy code and resume
162   FA3E              retv:
163   FA3E C3 7B FA         JP rtv
164   FA41              new:                ; Copy 1st part of fake NEW into grchbuf
165   FA41 11 58 FF         LD DE, grchbuf  ; Graphic character USR"a" buffer address
166   FA44 21 B7 11         LD HL, 0x11B7   ; NEW ROM1 1st routine block
167   FA47 01 47 00         LD BC, 0x0047   ; transfer 0x47 bytes 1st segment
168   FA4A ED B0            LDIR
169   FA4C 21 19 12         LD HL, 0x1219   ; NEW ROM1 second block
170   FA4F 01 5D 00         LD BC, 0x005D   ; transfer 0x5D bytes
171   FA52 ED B0            LDIR
172   FA54 21 3B FA         LD HL, retu     ; add rtu return address at the end of fake NEW copy 1st part
173   FA57 01 03 00         LD BC, 0x03     ; transfer 3 bytes
174   FA5A ED B0            LDIR
175   FA5C C3 58 FF         JP grchbuf      ; execute 1st part of fake NEW
176   FA5F              rtu:
177   FA5F 11 58 FF         LD DE, grchbuf
178   FA62 21 76 12         LD HL ,0x1276
179   FA65 01 2A 00         LD BC, 0x002A
180   FA68 ED B0            LDIR
181   FA6A 21 3E FA         LD HL, retv     ; add rtv return address at the end of fake NEW copy 2nd part
182   FA6D 01 03 00         LD BC, 0x03
183   FA70 ED B0            LDIR
184   FA72 21 89 FD         LD HL, pomsg
185   FA75 22 79 FF         LD (grchbuf+0x21),HL
186   FA78 C3 58 FF         JP grchbuf      ; execute 2nd part of fake NEW with pomsg welcome message and resume at rtv
187   FA7B              rtv:
188   FA7B CF               RST 0x08        ; Call Hook at ROM2
189   FA7C 31               DEFB 0x31       ; Creates the new system variables used by the Interface 1
190   FA7D 21 3C F7         LD HL, exten
191   FA80 22 B7 5C         LD (VECTOR),HL  ; Load our "exten" new command service routine into VECTOR System Variable
192   FA83 21 FF FF         LD HL, 0xFFFF   ; Copy Graphic Characters from ROM1 into used grchbuf top-down
193   FA86 11 AF 3E         LD DE, 0x3EAF
194   FA89 01 A0 00         LD BC,0x00A0
195   FA8C EB               EX DE,HL
196   FA8D ED B8            LDDR
197   FA8F 3A 6A 5C         LD A,(0x5C6A)   ; Activate Uppercase to easy new command
198   FA92 CB DF            SET 3,A
199   FA94 32 6A 5C         LD (0x5C6A),A   ; FLAGS2 00000100 (Set CAPS LOCK)
200   FA97 3E 00            LD A,0x00
201   FA99 32 91 5C         LD (0x5C91),A   ; P-FLAGS 01011000 (Paper 9 temp, Ink 9 temp, Inverse permanent)
202   FA9C C3 A9 12         JP 0x12A9       ; MAIN-1 tranfer back control to ROM1 main execution loop
203   FA9F              ; gap  REN. Command
204   FA9F 00 00 00...      DS 0xFADA-$,0
205   FADA              rren:
206   FADA D7               RST CALROM1
207   FADB 20 00            DEFW NEXCHA
208   FADD D7               RST CALROM1
209   FADE 7A 1C            DEFW 0x1C7A
210   FAE0 CD B7 05         CALL 0x5B7
211   FAE3 3A B0 5C         LD A,(0x5CB0)
212   FAE6 FE 06            CP 6
213   FAE8 C2 7C FC         JP NZ,rdel
214   FAEB D7               RST CALROM1
215   FAEC F1 FA            DEFW renum
216   FAEE C3 C1 05         JP 0x5C1
217   FAF1              renum:
218   FAF1 CD 99 1E         CALL 0x1E99
219   FAF4 C5               PUSH BC
220   FAF5 E1               POP HL
221   FAF6 22 02 5B         LD (0x5B02),HL
222   FAF9 CD 99 1E         CALL 0x1E99
223   FAFC C5               PUSH BC
224   FAFD E1               POP HL
225   FAFE 22 00 5B         LD (0x5B00),HL
226   FB01 7C               LD A,H
227   FB02 B5               OR L
228   FB03 C8               RET Z
229   FB04 2A 02 5B         LD HL,(0x5B02)
230   FB07 7C               LD A,H
231   FB08 B5               OR L
232   FB09 C8               RET Z
233   FB0A 2A 53 5C         LD HL,(0x5C53)
234   FB0D ED 5B 00 5B      LD DE,(0x5B00)
235   FB11              nxtln:
236   FB11 CD 70 FC         CALL chck
237   FB14 30 16            JR NC,fndgt
238   FB16 46               LD B,(HL)
239   FB17 72               LD (HL),D
240   FB18 23               INC HL
241   FB19 4E               LD C,(HL)
242   FB1A 73               LD (HL),E
243   FB1B 23               INC HL
244   FB1C 71               LD (HL),C
245   FB1D 34               INC (HL)
246   FB1E 70               LD (HL),B
247   FB1F 23               INC HL
248   FB20 E5               PUSH HL
249   FB21 2A 02 5B         LD HL,(0x5B02)
250   FB24 19               ADD HL,DE
251   FB25 EB               EX DE,HL
252   FB26 E1               POP HL
253   FB27 CD 65 FC         CALL eol
254   FB2A 18 E5            JR nxtln
255   FB2C              fndgt:
256   FB2C 2A 33 5C         LD HL,(0x5C33)
257   FB2F 23               INC HL
258   FB30 23               INC HL
259   FB31 23               INC HL
260   FB32 23               INC HL
261   FB33              srch:
262   FB33 CD 0F FC         CALL fnd
263   FB36 D2 DC FB         JP NC,rstr
264   FB39 54               LD D,H
265   FB3A 5D               LD E,L
266   FB3B 06 00            LD B,0x0
267   FB3D              nxtdg:
268   FB3D 04               INC B
269   FB3E 23               INC HL
270   FB3F 7E               LD A,(HL)
271   FB40 FE 2C            CP ","
272   FB42 20 01            JR NZ,cntn
273   FB44              fndnx:
274   FB44 EB               EX DE,HL
275   FB45              cntn:
276   FB45 18 EC            JR srch
277   FB47 FE 0E            CP 0x0E ; 14 id of floating point
278   FB49 20 F2            JR NZ,nxtdg
279   FB4B 23               INC HL
280   FB4C 23               INC HL
281   FB4D 23               INC HL
282   FB4E 23               INC HL
283   FB4F 23               INC HL
284   FB50 23               INC HL
285   FB51 7E               LD A,(HL)
286   FB52 FE 3A            CP ":"
287   FB54 28 04            JR Z,fou
288   FB56 FE 0D            CP 0x0D ; 13
289   FB58 20 EA            JR NZ,fndnx
290   FB5A              fou:
291   FB5A 78               LD A,B
292   FB5B              cmpr:
293   FB5B FE 04            CP 0X04
294   FB5D 28 10            JR Z,clclt
295   FB5F 20 E3            JR NZ,fndnx
296   FB61 D5               PUSH DE
297   FB62 62               LD H,D
298   FB63 6B               LD L,E
299   FB64 F5               PUSH AF
300   FB65 3E 30            LD A,"0"
301   FB67 CD 00 0F         CALL 0X0F00
302   FB6A F1               POP AF
303   FB6B 3C               INC A
304   FB6C D1               POP DE
305   FB6D 18 EC            JR cmpr
306   FB6F              clclt:
307   FB6F 42               LD B,D
308   FB70 3B               DEC SP      ; LD C,E
309   FB71 D5               PUSH DE
310   FB72 21 00 00         LD HL,0x0000
311   FB75 11 E8 03         LD DE,0x03E8    ; 1000
312   FB78 CD 06 FC         CALL ladd
313   FB7B 11 64 00         LD DE, 0x0064   ; 100
314   FB7E CD 06 FC         CALL ladd
315   FB81 1E 0A            LD E,0x0A       ; 10
316   FB83 CD 06 FC         CALL ladd
317   FB86 0A               LD A,(BC)
318   FB87 D6 30            SUB "0"
319   FB89 5F               LD E,A
320   FB8A 19               ADD HL,DE
321   FB8B 44               LD B,H
322   FB8C 4D               LD C,L
323   FB8D 2A 53 5C         LD HL,(0x5C53)
324   FB90              fndln:
325   FB90 23               INC HL
326   FB91 23               INC HL
327   FB92              eop:
328   FB92 CD 70 FC         CALL chck
329   FB95 38 03            JR C,xsts
330   FB97 E1               POP HL
331   FB98 18 99            JR srch
332   FB9A              xsts:
333   FB9A 7E               LD A,(HL)
334   FB9B B9               CP C
335   FB9C 30 07            JR NC,nxtbt
336   FB9E 23               INC HL
337   FB9F              wrng:
338   FB9F 23               INC HL
339   FBA0 CD 65 FC         CALL eol
340   FBA3 18 EB            JR fndln
341   FBA5              nxtbt:
342   FBA5 23               INC HL
343   FBA6 7E               LD A,(HL)
344   FBA7 B8               CP B
345   FBA8 38 F5            JR C,wrng
346   FBAA 2B               DEC HL
347   FBAB 2B               DEC HL
348   FBAC 4E               LD C,(HL)
349   FBAD 2B               DEC HL
350   FBAE 66               LD H,(HL)
351   FBAF 69               LD L,C
352   FBB0 C1               POP BC
353   FBB1 C5               PUSH BC
354   FBB2 E5               PUSH HL
355   FBB3 11 E8 03         LD DE,0X03E8 ; 1000
356   FBB6 CD F8 FB         CALL nsrt
357   FBB9 11 64 00         LD DE,0x0064
358   FBBC CD F8 FB         CALL nsrt
359   FBBF 1E 0A            LD E,0x0A
360   FBC1 CD F8 FB         CALL nsrt
361   FBC4 1E 01            LD E,1
362   FBC6 CD F8 FB         CALL nsrt
363   FBC9 03               INC BC
364   FBCA 97               SUB A
365   FBCB 02               LD (BC),A
366   FBCC 03               INC BC
367   FBCD 02               LD (BC),A
368   FBCE 03               INC BC
369   FBCF E1               POP HL
370   FBD0 7D               LD A,L
371   FBD1 02               LD (BC),A
372   FBD2 03               INC BC
373   FBD3 7C               LD A,H
374   FBD4 02               LD (BC),A
375   FBD5 03               INC BC
376   FBD6 97               SUB A
377   FBD7 02               LD (BC),A
378   FBD8 E1               POP HL
379   FBD9 C3 33 FB         JP srch
380   FBDC              rstr:
381   FBDC 2A 53 5C         LD HL,(0x5C53)
382   FBDF              fllw:
383   FBDF 23               INC HL
384   FBE0 23               INC HL
385   FBE1 CD 70 FC         CALL chck
386   FBE4 D0               RET NC
387   FBE5 44               LD B,H
388   FBE6 4D               LD C,L
389   FBE7 CD 65 FC         CALL eol
390   FBEA E5               PUSH HL
391   FBEB A7               AND A
392   FBEC ED 42            SBC HL,BC
393   FBEE 2B               DEC HL
394   FBEF 2B               DEC HL
395   FBF0 7D               LD A,L
396   FBF1 02               LD (BC),A
397   FBF2 03               INC BC
398   FBF3 7C               LD A,H
399   FBF4 02               LD (BC),A
400   FBF5 E1               POP HL
401   FBF6 18 E7            JR fllw
402   FBF8              nsrt:
403   FBF8 3E 30            LD A,0x30   ; +40
404   FBFA              sbtr:
405   FBFA A7               AND A
406   FBFB ED 52            SBC HL,DE
407   FBFD 38 03            JR C,poke
408   FBFF 3C               INC A
409   FC00 18 F8            JR sbtr
410   FC02              poke:
411   FC02 19               ADD HL,DE
412   FC03 02               LD (BC),A
413   FC04 03               INC BC
414   FC05 C9               RET
415   FC06              ladd:
416   FC06 0A               LD A,(BC)
417   FC07 03               INC BC
418   FC08 D6 2F            SUB 0x2F    ;  +47
419   FC0A              repea:
420   FC0A 3D               DEC A
421   FC0B C8               RET Z
422   FC0C 19               ADD HL,DE
423   FC0D 18 FB            JR repea
424   FC0F              fnd:
425   FC0F 7E               LD A,(HL)
426   FC10 CD 70 FC         CALL chck
427   FC13 D0               RET NC
428   FC14 FE EA            CP 0xEA
429   FC16 20 0D            JR NZ,ntrem
430   FC18              fntr:
431   FC18 23               INC HL
432   FC19 7E               LD A,(HL)
433   FC1A FE 0D            CP 0x0D     ; 13
434   FC1C 20 FA            JR NZ,fntr
435   FC1E              ncrs:
436   FC1E 23               INC HL
437   FC1F 23               INC HL
438   FC20 23               INC HL
439   FC21 23               INC HL
440   FC22 23               INC HL
441   FC23 18 EA            JR fnd
442   FC25              ntrem:
443   FC25 FE 22            CP 0x22
444   FC27 20 09            JR NZ,nstrg
445   FC29              nxchr:
446   FC29 23               INC HL
447   FC2A 7E               LD A,(HL)
448   FC2B FE 22            CP 0X22
449   FC2D 20 FA            JR NZ, nxchr
450   FC2F 23               INC HL
451   FC30 18 DD            JR fnd
452   FC32              nstrg:
453   FC32 FE 0D            CP 0x0D
454   FC34 28 E8            JR Z,ncrs
455   FC36 CD B6 18         CALL 0x18B6
456   FC39 28 D4            JR Z,fnd
457   FC3B FE ED            CP 0xED
458   FC3D 28 1B            JR Z,chkdg
459   FC3F FE EC            CP 0xEC
460   FC41 28 17            JR Z,chkdg
461   FC43 FE F7            CP 0xF7
462   FC45 28 13            JR Z,chkdg
463   FC47 FE F0            CP 0xF0
464   FC49 28 0F            JR Z,chkdg
465   FC4B FE E5            CP 0xE5
466   FC4D 28 0B            JR Z,chkdg
467   FC4F FE E1            CP 0xE1
468   FC51 28 07            JR Z,chkdg
469   FC53 FE CA            CP 0xCA
470   FC55 28 03            JR Z,chkdg
471   FC57 23               INC HL
472   FC58 18 B5            JR fnd
473   FC5A              chkdg:
474   FC5A 23               INC HL
475   FC5B 7E               LD A,(HL)
476   FC5C FE 30            CP 0x30
477   FC5E 38 AF            JR C,fnd ; JR Z,fnd
478   FC60 FE 3A            CP 0x3A
479   FC62 30 AB            JR NC,fnd
480   FC64 C9               RET
481   FC65              eol:
482   FC65 7E               LD A,(HL)
483   FC66              again:
484   FC66 CD B6 18         CALL 0x18B6
485   FC69 28 FB            JR Z,again
486   FC6B FE 0D            CP 0x0D
487   FC6D 23               INC HL
488   FC6E 20 F5            JR NZ,eol
489   FC70              chck:
490   FC70 E5               PUSH HL
491   FC71 D5               PUSH DE
492   FC72                  ;LD DE,(0x4B5B)
493   FC72 ED 5B 4B 5C      DEFB 0xED,0x5B,0x4B,0x5C
494   FC76 A7               AND A
495   FC77 ED 52            SBC HL,DE
496   FC79 D1               POP DE
497   FC7A E1               POP HL
498   FC7B C9               RET
499   FC7C
500   FC7C              ; gap  DEL. Command
501   FC7C                  DS 0xFC7C-$,0
502   FC7C              rdel:
503   FC7C D7               RST CALROM1
504   FC7D 82 FC            DEFW delet
505   FC7F C3 C1 05         JP 0x05C1
506   FC82              delet:
507   FC82 CD 99 1E         CALL 0x1E99
508   FC85 C5               PUSH BC
509   FC86 CD 99 1E         CALL 0x1E99
510   FC89 C5               PUSH BC
511   FC8A E1               POP HL
512   FC8B D1               POP DE
513   FC8C 7C               LD A,H
514   FC8D B5               OR L
515   FC8E C8               RET Z
516   FC8F 7A               LD A,D
517   FC90 B3               OR E
518   FC91 C8               RET Z
519   FC92 D5               PUSH DE
520   FC93 CD 6E 19         CALL 0x196E
521   FC96 E3               EX (SP),HL
522   FC97 23               INC HL
523   FC98 CD 6E 19         CALL 0x196E
524   FC9B D1               POP DE
525   FC9C A7               AND A
526   FC9D ED 52            SBC HL, DE
527   FC9F C8               RET Z
528   FCA0 D8               RET C
529   FCA1 44               LD B,H
530   FCA2 4D               LD C,L
531   FCA3 19               ADD HL,DE
532   FCA4 EB               EX DE,HL
533   FCA5 CD E8 19         CALL 0x19E8
534   FCA8 C9               RET
535   FCA9
536   FCA9
537   FCA9
538   FCA9              ; gap
539   FCA9                  DS 0xFCA9-$,0
540   FCA9              rfnd:               ; .FND Find string in Basic lines command
541   FCA9 D7               RST CALROM1
542   FCAA 20 00            DEFW NEXCHA     ; Parse a character
543   FCAC D7               RST CALROM1        ; Parse to end of string
544   FCAD 8C 1C            DEFW 0x1C8C
545   FCAF CD B7 05         CALL 0x05B7     ; Exit editor
546   FCB2 D7               RST CALROM1
547   FCB3 E3 FC            DEFW sr0        ; call sr0 in ROM1 0xFCE3
548   FCB5 C3 C1 05         JP 0x05C1       ; command exit
549   FCB8              rcha:               ; .CHA Change string command
550   FCB8 D7               RST CALROM1
551   FCB9 20 00            DEFW NEXCHA     ; Parse next character
552   FCBB D7               RST CALROM1
553   FCBC 8C 1C            DEFW 0x1C8C     ; Parse to end of string in ROM1
554   FCBE FE CC            CP 0xCC
555   FCC0 C2 F0 01         JP NZ,0x01F0    ; Error if  we do not have a 'TO' separator
556   FCC3 D7               RST CALROM1
557   FCC4 20 00            DEFW NEXCHA     ; Next character
558   FCC6 D7               RST CALROM1        ; Parse a character string
559   FCC7 8C 1C            DEFW 0x1C8C
560   FCC9 CD B7 05         CALL 0x05B7     ; Exit editor
561   FCCC D7               RST CALROM1        ; call ch0 with ROM1
562   FCCD D2 FC            DEFW ch0
563   FCCF C3 C1 05         JP 0x05C1       ; Command exit
564   FCD2              ch0:
565   FCD2 CD F1 2B         CALL 0x2BF1     ; DE = last string start
566   FCD5 79               LD A,C          ; BC = last string length
567   FCD6 FE 00            CP 0            ; length is 0?
568   FCD8 C8               RET Z           ; Resume Basic
569   FCD9 21 00 5B         LD HL,0x5B00
570   FCDC 71               LD (HL),C       ; second string length into 0x5B00
571   FCDD 23               INC HL
572   FCDE 70               LD (HL),B
573   FCDF 23               INC HL
574   FCE0 EB               EX DE, HL       ; Copy in 0x5B02 second string
575   FCE1 ED B0            LDIR
576   FCE3              sr0:
577   FCE3 CD F1 2B         CALL 0x2BF1
578   FCE6 D5               PUSH DE
579   FCE7 DD E1            POP IX
580   FCE9 79               LD A,C
581   FCEA 32 81 5C         LD (var01),A
582   FCED              sr1:
583   FCED FD CB 02 86      RES 0,(IY+2)
584   FCF1 2A 53 5C         LD HL,(0x5C53)
585   FCF4              sr2:
586   FCF4 3A 81 5C         LD A,(var01)
587   FCF7 5F               LD E,A
588   FCF8 FE 00            CP 0x0
589   FCFA C8               RET Z
590   FCFB E5               PUSH HL
591   FCFC              sr3:
592   FCFC DD E5            PUSH IX
593   FCFE C1               POP BC
594   FCFF 16 00            LD D,0x0
595   FD01 23               INC HL
596   FD02 23               INC HL
597   FD03 23               INC HL
598   FD04              sr4:
599   FD04 23               INC HL
600   FD05 D5               PUSH DE
601   FD06 ED 5B 4B 5C      LD DE,(0x5C4B)
602   FD0A AF               XOR A
603   FD0B A7               AND A
604   FD0C ED 52            SBC HL,DE
605   FD0E 19               ADD HL,DE
606   FD0F D1               POP DE
607   FD10 38 02            JR C,sr5
608   FD12 E1               POP HL
609   FD13 C9               RET
610   FD14              sr5:
611   FD14 7E               LD A,(HL)
612   FD15 FE 0D            CP 0x0D
613   FD17 20 05            JR NZ,sr6
614   FD19 23               INC HL
615   FD1A C1               POP BC
616   FD1B E5               PUSH HL
617   FD1C 18 DE            JR sr3
618   FD1E              sr6:
619   FD1E CD B6 18         CALL 0x18B6
620   FD21 20 11            JR NZ,sr8
621   FD23 2B               DEC HL
622   FD24              sr7:
623   FD24 7A               LD A,D
624   FD25 FE 00            CP 0x0
625   FD27 28 04            JR Z,sr71
626   FD29 42               LD B,D
627   FD2A              sr70:
628   FD2A 2B               DEC HL
629   FD2B 10 FD            DJNZ sr70
630   FD2D              sr71:
631   FD2D DD E5            PUSH IX
632   FD2F C1               POP BC
633   FD30 16 00            LD D,0
634   FD32 18 D0            JR sr4
635   FD34              sr8:
636   FD34 0A               LD A,(BC)
637   FD35 BE               CP (HL)
638   FD36 20 EC            JR NZ,sr7
639   FD38 03               INC BC
640   FD39 14               INC D
641   FD3A 7A               LD A,D
642   FD3B BB               CP E
643   FD3C 20 C6            JR NZ,sr4
644   FD3E 3A B0 5C         LD A,(0x5CB0)
645   FD41 FE 0A            CP 0x0A ; Jump if command is .CHA
646   FD43 20 12            JR NZ,ch1
647   FD45              sr9:
648   FD45 E1               POP HL
649   FD46 E5               PUSH HL
650   FD47 46               LD B,(HL)
651   FD48 23               INC HL
652   FD49 4E               LD C,(HL)
653   FD4A ED 43 49 5C      LD (0x5C49),BC
654   FD4E E1               POP HL
655   FD4F CD 55 18         CALL 0x1855
656   FD52 3E 0D            LD A,0x0D
657   FD54 D7               RST CALROM1
658   FD55 18 9D            JR sr2
659   FD57              ch1:
660   FD57 7B               LD A,E
661   FD58 FE 01            CP 0x1
662   FD5A 28 05            JR Z,ch3
663   FD5C 3D               DEC A
664   FD5D 47               LD B,A
665   FD5E              ch2:
666   FD5E 2B               DEC HL
667   FD5F 10 FD            DJNZ ch2
668   FD61              ch3:
669   FD61 3A 00 5B         LD A,(0x5B00)
670   FD64 BB               CP E
671   FD65 28 08            JR Z,ch4
672   FD67 38 06            JR C,ch4
673   FD69 7B               LD A,E
674   FD6A 32 00 5B         LD (0x5B00),A
675   FD6D 18 00            JR ch4
676   FD6F              ch4:
677   FD6F EB               EX DE,HL
678   FD70 21 02 5B         LD HL,0x5B02
679   FD73 06 00            LD B,0x0
680   FD75 3A 00 5B         LD A,(0x5B00)
681   FD78 4F               LD C,A
682   FD79 ED B0            LDIR
683   FD7B EB               EX DE,HL
684   FD7C 2B               DEC HL
685   FD7D DD E5            PUSH IX
686   FD7F C1               POP BC
687   FD80 3A 81 5C         LD A,(0x5C81)
688   FD83 16 00            LD D,0
689   FD85 5F               LD E,A
690   FD86 C3 04 FD         JP sr4
691   FD89              pomsg:
692   FD89 A0               DEFB 0xA0
693   FD8A 4D 69 63 72      DEFB "Micro Basic O.S. ANC SPAIN "
693   FD8E 6F 20 42 61
693   FD92 73 69 63 20
693   FD96 4F 2E 53 2E
693   FD9A 20 41 4E 43
693   FD9E 20 53 50 41
693   FDA2 49 4E 20
694   FDA5 7F               DEFB 0x7F
695   FDA6 31 39 38         DEFB "198"
696   FDA9 B4               DEFB 0xB4
697   FDAA              raof:
698   FDAA D7               RST CALROM1
699   FDAB 20 00            DEFW NEXCHA
700   FDAD CD B7 05         CALL 0x05B7
701   FDB0 F3               DI
702   FDB1 3E 3E            LD A,0x3E
703   FDB3 ED 47            LD I,A
704   FDB5 ED 56            IM 1
705   FDB7 FB               EI
706   FDB8 C3 C1 05         JP 0x05C1
707   FDBB              raon:
708   FDBB D7               RST CALROM1
709   FDBC 20 00            DEFW NEXCHA
710   FDBE CD B7 05         CALL 0x05B7
711   FDC1 F3               DI
712   FDC2 21 4A F7         LD HL,vecin
713   FDC5 11 69 FE         LD DE,0xFE69
714   FDC8 01 03 00         LD BC,0x0003
715   FDCB ED B0            LDIR
716   FDCD 3E 09            LD A,0x09
717   FDCF ED 47            LD I,A
718   FDD1 ED 5E            IM 2
719   FDD3 FB               EI
720   FDD4 C3 C1 05         JP 0x05C1
721   FDD7              trac0:
722   FDD7 00               DEFB 0x0
723   FDD8              inter:
724   FDD8 FF               RST 0x038
725   FDD9 F3               DI
726   FDDA F5               PUSH AF
microbasic.asm(727): warning: Accessing low memory address 0x0000, is it ok?: LD A,(0x0000)   
727   FDDB 3A 00 00         LD A,(0x0000)   ; Identify which ROM is active
728   FDDE FE E1            CP 0xE1
729   FDE0 20 03            JR NZ,rom1      ; If we are in ROM2, just exit from ISR
730   FDE2 F1               POP AF
731   FDE3 FB               EI
732   FDE4 C9               RET
733   FDE5              rom1:
734   FDE5 E5               PUSH HL
735   FDE6 D5               PUSH DE
736   FDE7 C5               PUSH BC
737   FDE8 3A D7 FD         LD A,(trac0)
738   FDEB FE 00            CP 0x0
739   FDED 20 27            JR NZ,trac4
740   FDEF 3A 82 5C         LD A,(0x5C82)   ; ECHO-E Column &line number. End of input
741   FDF2 FE 20            CP 0x20
742   FDF4 20 6D            JR NZ,trac3
743   FDF6 3A 83 5C         LD A,(0x5C83)   ;
744   FDF9 FE 17            CP 0x17
745   FDFB 20 66            JR NZ,trac3
746   FDFD 21 08 5C         LD HL,0x5C08    ; Last key pressed
747   FE00 7E               LD A,(HL)
748   FE01 FE 0C            CP 0x0C
749   FE03 28 5E            JR Z,trac3
750   FE05 21 04 5C         LD HL,0x5C04
751   FE08 7E               LD A,(HL)
752   FE09 FE 0D            CP 0x0D
753   FE0B 28 04            JR Z,twrit
754   FE0D FE FF            CP 0xFF
755   FE0F 20 52            JR NZ,trac3
756   FE11              twrit:
757   FE11 3E 04            LD A,0x04
758   FE13 32 D7 FD         LD (trac0),A
759   FE16              trac4:
760   FE16 3A D7 FD         LD A,(trac0)
761   FE19 3D               DEC A
762   FE1A 32 D7 FD         LD (trac0),A
763   FE1D 2A 49 5C         LD HL,(0x5C49)
764   FE20 11 0A 00         LD DE,0x000A
765   FE23 19               ADD HL,DE
766   FE24 01 10 FC         LD BC,0xFC10
767   FE27 CD 4A FE         CALL trac1
768   FE2A FE 03            CP 0x03
769   FE2C 28 35            JR Z,trac3
770   FE2E 01 9C FF         LD BC,0xFF9C
771   FE31 CD 4A FE         CALL trac1
772   FE34 FE 02            CP 0x02
773   FE36 28 2B            JR Z,trac3
774   FE38 01 F6 FF         LD BC,0xFFF6
775   FE3B CD 4A FE         CALL trac1
776   FE3E FE 01            CP 0x01
777   FE40 28 21            JR Z,trac3
778   FE42 01 FF FF         LD BC,0xFFFF
779   FE45 CD 4A FE         CALL trac1
780   FE48 18 19            JR trac3
781   FE4A              trac1:
782   FE4A AF               XOR A
783   FE4B              trac2:
784   FE4B 09               ADD HL,BC
785   FE4C 3C               INC A
786   FE4D 38 FC            JR C,trac2
787   FE4F ED 42            SBC HL,BC
788   FE51 3D               DEC A
789   FE52 C6 30            ADD A,0x30
790   FE54 32 08 5C         LD (0x5C08),A
791   FE57 3A 3B 5C         LD A,(0x5C3B)
792   FE5A CB EF            SET 5,A
793   FE5C 32 3B 5C         LD (0x5C3B),A
794   FE5F 3A D7 FD         LD A,(trac0)
795   FE62 C9               RET
796   FE63              trac3:
797   FE63 C1               POP BC
798   FE64 D1               POP DE
799   FE65 E1               POP HL
800   FE66 F1               POP AF
801   FE67 FB               EI
802   FE68 C9               RET
803   FE69              lbjp:
804   FE69 FE FE FE FE      DEFB 0xFE,0xFE,0xFE,0xFE
805   FE6D              ; Screen$
806   FE6D              ; gap
807   FE6D 00 00 00...      DS 0xFEF0-$
808   FEF0              rsave:
809   FEF0 3E F8            LD A,0xF8
810   FEF2 18 0A            JR sacon
811   FEF4              rload:
812   FEF4 3E EF            LD A,0xEF
813   FEF6 18 06            JR sacon
814   FEF8              rvery:
815   FEF8 3E D6            LD A,0xD6
816   FEFA 18 02            JR sacon
817   FEFC              rmerg:
818   FEFC 3E D5            LD A,0xD5
819   FEFE              sacon:
820   FEFE 01 0A 00         LD BC,0x0A
821   FF01 11 39 FF         LD DE,texcm
822   FF04 18 1A            JR ampli
823   FF06              rmove:
824   FF06 3E D1            LD A,0xD1
825   FF08 18 06            JR mocon
826   FF0A              reras:
827   FF0A 3E D2            LD A,0xD2
828   FF0C 18 02            JR mocon
829   FF0E              rform:
830   FF0E 3E D0            LD a,0xD0
831   FF10              mocon:
832   FF10 11 43 FF         LD DE, texsa
833   FF13 01 09 00         LD BC,0x9
834   FF16 18 08            JR ampli
835   FF18              ropen:
836   FF18 3E D3            LD A,0xD3
837   FF1A 11 4C FF         LD DE,texop
838   FF1D 01 0B 00         LD BC, 0x0B
839   FF20              ampli:
840   FF20 D5               PUSH DE
841   FF21 C5               PUSH BC
842   FF22 12               LD (DE),A
843   FF23 D7               RST CALROM1
844   FF24 20 00            DEFW NEXCHA
845   FF26 C1               POP BC
846   FF27 C5               PUSH BC
847   FF28 0B               DEC BC
848   FF29 D7               RST CALROM1
849   FF2A 55 16            DEFW 0x1655
850   FF2C C1               POP BC
851   FF2D D1               POP DE
852   FF2E EB               EX DE,HL
853   FF2F ED B0            LDIR
854   FF31 EB               EX DE,HL
855   FF32 2B               DEC HL
856   FF33 22 5B 5C         LD (0x5C5B),HL
857   FF36 C3 F0 01         JP 0x01F0
858   FF39              texcm:
859   FF39 F8               DEFB 0xF8
860   FF3A              texmd:
861   FF3A 2A 22 6D 22      DEFB "*",0x22,"m",0x22,0x3B,"1",0x3B,0x22,0x22
861   FF3E 3B 31 3B 22
861   FF42 22
862   FF43              texsa
863   FF43 D1 22 6D 22      DEFB 0xD1,0x22,"m",0x22,0x3B,"1",0x3B,0x22,0x22
863   FF47 3B 31 3B 22
863   FF4B 22
864   FF4C              texop:
865   FF4C D3 38 3B 22      DEFB 0xD3,"8",0x3B,0x22,"m",0x22,0x3B,"1",0x3B,0x22,0x22
865   FF50 6D 22 3B 31
865   FF54 3B 22 22
866   FF57
# file closed: microbasic.asm
